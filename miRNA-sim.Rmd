---
title: "miRNA and siRNA modelling"
output: html_notebook
---


```{r setup}
library(deSolve)
library(tidyverse)
library(ggridges)
library(cowplot)
```

# Outstanding questions

- do we measure uncleave target RNA or free target mRNA? (matters only in 3T3e cells)
  We measure protein (AGO bound is repressed)
- What exactly is measured? All sequences complementary to let7?
- total RNA MSC?

# Assumptions

Using nM/l as unit, K_m and k_cat from Zamore 2015.

Notes 2018-09-05:
miRNA does not deplete in ooczt ine  20h
miRNA silencing hapens on the order of hours
Need to consider competition with siRNAs and loading unloading
AGO + siRNA will stay loaded, AGO + miRNA might not
AGO + miRNA has intermediate stages

Denzler has total miRNA to siRNA counts (hopefully). 
3T3 cell has only miRNA (but siRNA can be induced)

miRNA seed vs. seed and something


Further notes:
In Zamore 2012 Fig. 7 the $K_M$ values are about a factor of 2.5 off from what would be calculated from $k_{on}$, $k_{off}$ and $k_cat$ - those are different experiments.

Bosson 2014:
Absolute levels of miRNAs for various cell types are estimated in the range of tens to 
120,000 copies per cell

This method provided target cpc estimates of 1,200 8-mers, 5,000 7-mers, and 22,000 6-
mers on average for 3â€² UTR sites of each active miRNA ESC family (Figure 3D, lines). For 
reference to other cell types, these values correspond to 0.8%, 3.2%, and 14.1% of the total 
mRNA concentration in the cell. 

Assuming AGO is not rate limiting, we simplify the reaction and treat the  specific miRNA/siRNA species as enzyme in the reactions.

```{r}
#mole_unit <- 6.022e20 #Mili mole
# mole_unit_from_nano_mole <- 1e-6
# mole_unit_from_mole <- 1e3


#Using litre as volume unit! (since constants are in moles per litre)
mole_unit <- 6.022e14 #nano mole
mole_unit_from_nano_mole <- 1
mole_unit_from_mole <- 1e9
time_unit_from_sec <- 1/3600 #Use hour instead of seconds

K_M_siRNA <- 0.1 * mole_unit_from_nano_mole
k_on_siRNA <- 3.6e7 / (mole_unit_from_mole * time_unit_from_sec)
k_off_siRNA <- 7.7e-4 / time_unit_from_sec
k_cat_siRNA <- 8.1e-4 / time_unit_from_sec

k_on_miRNA <- 0.2e8 / (mole_unit_from_mole * time_unit_from_sec)
k_off_miRNA <- 0.051e-2 / time_unit_from_sec

cells <- tibble(
  name = c("3T3","oocyte"),
  volume = c(4.4e-12, 260e-12),
  total_RNA = c(5e5,25e6)
)

target_pools <- tibble(fraction_of_total_RNA = c(0.1,0.2))

miRNA_counts <- tibble(miRNA_count = c(5e4,1e4,5e3))

k_cat_coeff_step = 0.05
k_cat_coeffs <- tibble(k_cat_coeff = seq(0.05,1, by = k_cat_coeff_step))

all_conditions <- crossing(cells, target_pools, miRNA_counts, k_cat_coeffs)

times <- seq(0,24*60*60 * time_unit_from_sec, length.out = 101)
time_step <- diff(times)[1]

one_step_degradation <- function(t, state, parameters) {
  with(as.list(c(state, parameters)), {
    d_target <- -k_on * enzyme * target + k_off * complex 
    d_enzyme <- -k_on * enzyme * target + k_off * complex + k_cat * complex
    d_complex <- k_on * enzyme * target - k_off * complex - k_cat * complex
    list(c(d_target, d_enzyme, d_complex))
  })
}

plot_ode_result <- function(out, title) {
  out_tidy <- out %>% as.data.frame() %>% 
    gather(type, concentration, -time) %>%
    mutate(time_h = time / (3600 * time_unit_from_sec)) 
    
  
  uncleaved_plot <- out_tidy %>% 
    filter(type != "enzyme") %>%
    group_by(time_h) %>%
    summarise(all_uncleaved = sum(concentration)) %>%
    (function(data) { 
      ggplot(data,aes(x = time_h, y = all_uncleaved)) + geom_line() +
        ggtitle(paste0(title," uncleaved RNAs"))  +
        ylim(-1e-5, max(data$all_uncleaved)) 
    })

  print(uncleaved_plot)
  
  auxiliary_plot <- 
    ggplot(out_tidy, aes(x = time_h, y = concentration, color = type, linetype = type)) + geom_line() +
    ggtitle(paste0(title," all reactants") ) + 
    ylim(-1e-5, max(out_tidy$concentration))


  print(auxiliary_plot)
}

```

# let7 modelling

Modulating just k_cat for let7 is enough - to get full let7 efficiency at 3T3 cells but have negligible degradation in oocyte for $k_{cat,\mathrm{let7}} \in (0.05 * k_{cat,\mathrm{siRNA}}, 0.3 * k_{cat,\mathrm{siRNA}})$.

```{r}
miRNA_sim_single <- function(condition) {
  params <- c(k_cat = k_cat_siRNA * condition$k_cat_coeff, k_on = k_on_miRNA, k_off = k_off_miRNA)
  
  state <- c(target = condition$total_RNA * condition$fraction_of_total_RNA / condition$volume, enzyme = condition$miRNA_count / condition$volume, complex = 0)
  
  out <- ode(y = state, times = times, func = one_step_degradation, parms = params)

  tidy_out <- out %>% as.data.frame() %>%
    gather(type, concentration, -time) %>%
    mutate(time_h = time / (3600 * time_unit_from_sec)) 

  crossing(as.tibble(condition), tidy_out)
}

sim_results <- all_conditions %>%
  rowwise() %>% do(miRNA_sim_single(.)) %>% ungroup()
```


```{r}
```

```{r}
plot_concentration_surface <- function(to_show) {
  if(length(unique(to_show$fraction_of_total_RNA)) != 1) {
    stop("Has to be unique")
  }
 p <- to_show %>% filter(type == "target") %>% group_by(fraction_of_total_RNA, miRNA_count, name) %>% 
   mutate(concentration = if_else(concentration < 0, 0, concentration),
          rel_concentration = concentration / max(concentration)) %>%
  ungroup() %>%
  ggplot(aes(x=time_h, y = k_cat_coeff, fill = rel_concentration, z = rel_concentration)) + 
   geom_tile(width = 0.242424, height = 0.05) + geom_contour(color = "orange") + 
   #geom_point() +
   facet_grid(name~miRNA_count) +
   ggtitle(paste("targets/total RNA =", to_show$fraction_of_total_RNA[1]))
  print(p)
  data.frame()
}

sim_results %>%group_by(fraction_of_total_RNA) %>% do(plot_concentration_surface(.))

```

