---
title: "Simple miRNA computational modelling"
author: "Martin Modrak"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
---


```{r setup, message=FALSE}
#Next line is useful for Word output
#knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.width = 9)
library(deSolve)
library(tidyverse)
library(ggridges)
library(cowplot)
library(knitr)
options(dplyr.show_progress = FALSE)
```


# Assumptions

* miRNA degradation is modelled as one step process (similar to siRNA pathway), but with lower catalytic efficiency than the siRNA pathways
* The AGO2 concentration is assumed to not be rate limiting, in particular all miRNA is assumed to be loaded on AGO2 at all times
* All miRNA binding events are assumed to be those of pure seed pairing (for seed + additionial base pairing the binding is slightly stronger).
* only uncleaved free mRNA is observed in experiments (mRNA bound in complex with AGO2 + miRNA is not be observed).

# Mathematical model

The assumptions above lead to a simple description of the system as a set of differential equations. 
Denoting the concentration of free mRNA molecules with target sites for the miRNA in question as $[\mathrm{target}]$, the concentration of mRNA + miRNA + AGO2 complex as $[\mathrm{complex}]$ and the concentration of the miRNA + AGO2 complex as $[\mathrm{enzyme}]$ The kinetics are descibed as:

$$
\begin{align}
\frac{\mathrm{d}[\mathrm{target}]}{\mathrm{d}t} &= s_{excess}-k_{on}[\mathrm{target}][\mathrm{enzyme}] + k_{off}[\mathrm{complex}] \\
\frac{\mathrm{d}[\mathrm{complex}]}{\mathrm{d}t} &= k_{on}[\mathrm{target}][\mathrm{enzyme}] -  k_{off}[\mathrm{complex}] - k_{cat}[\mathrm{complex}] \\
\frac{\mathrm{d}[\mathrm{enzyme}]}{\mathrm{d}t} &= -k_{on}[\mathrm{target}][\mathrm{enzyme}] + k_{off}[\mathrm{complex}] + k_{cat}[\mathrm{complex}] \\
\end{align}
$$

Where $k_{on}$,${k_{off}}$ and $k_{cat}$ are the reaction rates in the system and $s_{excess}$ is the excess synthesis rate of new mRNA (i.e. synthesis minus degradation by normal cell processes). Except for the synthesis term, this is the same system as used in Michaelis-Menten kinetics.

# Input data

```{r}
### Define units and conversions
#Using litre as volume unit! (since constants are in moles per litre)
mole_unit <- 6.022e14 #nano mole
mole_unit_from_nano_mole <- 1
mole_unit_from_mole <- 1e9
#Using second as time unit
time_unit_from_sec <- 1

K_M_siRNA <- 0.1 * mole_unit_from_nano_mole
k_on_siRNA <- 3.6e7 / (mole_unit_from_mole * time_unit_from_sec)

k_off_siRNA <- 7.7e-4 / time_unit_from_sec
k_cat_siRNA <- 8.1e-4 / time_unit_from_sec
k_cat_siRNA_computed <- K_M_siRNA * k_on_siRNA - k_off_siRNA

k_on_miRNA <- 0.2e8 / (mole_unit_from_mole * time_unit_from_sec)
k_off_miRNA <- 0.051e-2 / time_unit_from_sec

### Combinations of data we use
volume_3T3 <- 4.4e-12 
total_RNA_3T3 <- 5e5
cells <- tibble(
  name = c("3T3 - no synth","3T3 - low synth","3T3 - high synth","oocyte"),
  volume = c(volume_3T3,volume_3T3,volume_3T3, 260e-12),
  total_RNA = c(total_RNA_3T3, total_RNA_3T3, total_RNA_3T3, 25e6),
  excess_RNA_synthesis = c(0, 5000 / 3600, 20000 / 3600, 0)
) %>% mutate(
  name = factor(name, levels = name)
)

target_pools <- tibble(fraction_of_total_RNA = c(0.1,0.2))

miRNA_counts <- tibble(miRNA_count = c(5e3,1e4,5e4))

k_cat_coeff_step = 0.05
k_cat_coeffs <- tibble(k_cat_coeff = seq(0.05,1, by = k_cat_coeff_step))

all_conditions <- crossing(cells, target_pools, miRNA_counts, k_cat_coeffs)

times <- seq(0,24*60*60 * time_unit_from_sec, length.out = 101)
time_step <- diff(times)[1]

one_step_degradation <- function(t, state, parameters) {
  with(as.list(c(state, parameters)), {
    d_target <- synthesis -k_on * enzyme * target + k_off * complex 
    d_enzyme <- -k_on * enzyme * target + k_off * complex + k_cat * complex
    d_complex <- k_on * enzyme * target - k_off * complex - k_cat * complex
    list(c(d_target, d_enzyme, d_complex))
  })
}

plot_ode_result <- function(out, title) {
  out_tidy <- out %>% as.data.frame() %>% 
    gather(type, concentration, -time) %>%
    mutate(time_h = time / (3600 * time_unit_from_sec)) 
    
  
  uncleaved_plot <- out_tidy %>% 
    filter(type != "enzyme") %>%
    group_by(time_h) %>%
    summarise(all_uncleaved = sum(concentration)) %>%
    (function(data) { 
      ggplot(data,aes(x = time_h, y = all_uncleaved)) + geom_line() +
        ggtitle(paste0(title," uncleaved RNAs"))  +
        ylim(-1e-5, max(data$all_uncleaved)) 
    })

  print(uncleaved_plot)
  
  auxiliary_plot <- 
    ggplot(out_tidy, aes(x = time_h, y = concentration, color = type, linetype = type)) + geom_line() +
    ggtitle(paste0(title," all reactants") ) + 
    ylim(-1e-5, max(out_tidy$concentration))


  print(auxiliary_plot)
}

```


We take $k_{on}$ and $k_{off}$ for the mouse miRNA system from from Wee, Flores-Jasso, Salomon & Zamore 2012, Argonaute Divides Its RNA Guide into Domains with Distinct Functions and RNA-Binding Properties, Figure 7. The same source also gives $k_{cat}$ for the siRNA pathway, which provides an upper bound on miRNA pathway efficiency.

We note that the $k_{cat}$ value for the siRNA pathway in the source is about a factor of 3.5 smaller from what would be calculated from the reported $k_{on}$, $k_{off}$ and $K_{M}$. This is because $k_{on}$, $k_{off}$ were determined in a different experiment than $K_M$ and $k_{cat}$, but gives a useful insight into generalizability of the value.

```{r}
tibble(k_cat_reported = k_cat_siRNA * time_unit_from_sec, k_cat_computed =  k_cat_siRNA_computed * time_unit_from_sec) %>% mutate(computed_to_reported_ratio = k_cat_computed / k_cat_reported) %>% kable()
```

For the follwoing we use the siRNA $k_{cat}$ as reported. TODO: should we do the higher computed $k_{cat}$ as well?

We assume the miRNA $k_{cat}$ to be lower than in siRNA, we test a range of values of a scaling coefficent $k_{cat,\mathrm{miRNA}} = k_{coeff} k_{cat,\mathrm{siRNA}}$:

```{r}
tibble(k_coeff_min = min(k_cat_coeffs$k_cat_coeff), k_coeff_max = max(k_cat_coeffs$k_cat_coeff), num_intermediate_values = nrow(k_cat_coeffs)) %>% kable()
```


We test dynamics in two cell types (3T3 and oocyte), with varying levels of excess mRNA synthesis as shown bellow - volume in picolitres, total_RNA in copies per cell (cpc) and excess RNA synthesis in added cpc per hour after accounting for normal degradation processes:
```{r}
cells %>% mutate(volume_pl = volume * 10^12, excess_RNA_synthesis = excess_RNA_synthesis * 3600) %>% select(-volume) %>%  kable()
```

We test different counts (cpc) of the miRNA species: 

```{r}
miRNA_counts %>% kable()
```

We test different amount of target mRNAs as fraction of the total RNA in the cell:
```{r}
target_pools %>% kable()
```

We solve the differential equation system for all possible combination of those values. 

```{r}
# Getting the initial complex concentration at equilibrium

# K_D = k_on / k_off
# c/t*e = K_D
# c = t*e*K_D
# 
# t  = t_i - c
# e  = e_i - c
# 
# c = (t_i - c)*(e_i-c)*K_D
# 
# c = c^2 * K_D + c*(-e_i -t_i)*K_D + e_i * t_i * K_D
# 0 = c^2 * K_D + c*((-e_i -t_i)*K_D - 1) + e_i * t_i * K_D
# 
# D = ((-e_i -t_i)*K_D - 1)^2 - 4*e_i * t_i * K_D^2
# c = ( -((-e_i -t_i)*K_D - 1)  +- sqrt(D) ) / (2 * K_D)
# c = ( (e_i + t_i) * K_D + 1 + sqrt(D) ) / (2 * K_D)

```


```{r computing_model, cache=TRUE}
miRNA_sim_single <- function(condition, init_complex_equilibrium = TRUE) {
  params <- c(k_cat = k_cat_siRNA * condition$k_cat_coeff, 
              k_on = k_on_miRNA, 
              k_off = k_off_miRNA,
              synthesis = (condition$excess_RNA_synthesis / mole_unit) * (condition$fraction_of_total_RNA / condition$volume)
              )
  
  #Init the enzyme and complex at equilibrium
  total_target <- (condition$total_RNA / mole_unit) * (condition$fraction_of_total_RNA / condition$volume)
  total_enzyme <- condition$miRNA_count / (condition$volume * mole_unit)
  
  
  if(init_complex_equilibrium) {
    K_D <-  params["k_on"] / params["k_off"]
    names(K_D) <- NULL #For some reason, this has name and it messes up later computations
    complex_D <- (((total_target + total_enzyme) * K_D + 1) ^ 2) - 4 * total_target * total_enzyme * (K_D^2)
    initial_complex <- ((total_target + total_enzyme) * K_D + 1 - sqrt(complex_D)) / (2 * K_D)
    
    free_target <- total_target - initial_complex
    free_enzyme <- total_enzyme - initial_complex
    
    #Check that the equilibirum calculation is OK
    if(free_enzyme < 0 || free_target < 0 || initial_complex < 0) {
      stop("Concentrations below zero")
    }
    check <- initial_complex / (free_target * free_enzyme)
    if(abs(check - K_D) > 1e-8) {
      stop("Not equilibrium")
    }
  
    state <- c(target = free_target, enzyme = free_enzyme, complex = initial_complex)
  } else {
    initial_complex = 0
    state <- c(target = total_target, enzyme = total_enzyme, complex = 0)
  }
  
  out <- ode(y = state, times = times, func = one_step_degradation, parms = params)

  tidy_out <- out %>% as.data.frame() %>%
    gather(type, concentration, -time) %>%
    mutate(time_h = time / (3600 * time_unit_from_sec)) 

  crossing(as.tibble(condition), tidy_out)
}

sim_results <- all_conditions %>%
  rowwise() %>% do(miRNA_sim_single(., init_complex_equilibrium = TRUE)) %>% ungroup()
```

# Modelling Results

Below, we show the landscapes of concentrations of free miRNA targets over time for various coefficients for $k_{cat}$. Each landscape plot corresponds to one of the simulated conditions (fraction of total RNA that are targets, miRNA count, type of cell). The concentration is reported relative to initial concentration of the free miRNA.

```{r}
plot_concentration_surface <- function(to_show) {
  if(length(unique(to_show$fraction_of_total_RNA)) != 1) {
    stop("Has to be unique")
  }
  
  label_miRNA_count <- function(value) {
    paste0("#miRNA=",round(as.numeric(value)/1000),"K")
  }
  
 p <- to_show %>% filter(type == "target") %>% group_by(fraction_of_total_RNA, miRNA_count, name) %>% 
   mutate(concentration = if_else(concentration < 0, 0, concentration),
          relative_concentration = concentration / max(concentration)) %>%
  ungroup() %>%
  ggplot(aes(x=time_h, y = k_cat_coeff, fill = relative_concentration, z = relative_concentration)) + 
   geom_raster() + 
   scale_fill_distiller(palette = "Spectral") +
   facet_grid(miRNA_count~name, labeller= labeller(miRNA_count = label_miRNA_count)) +
   ggtitle(paste("targets/total RNA =", to_show$fraction_of_total_RNA[1]))
  print(p)
  data.frame()
}

sim_results %>%group_by(fraction_of_total_RNA) %>% do(plot_concentration_surface(.)) %>% invisible()

```

We see that even with the exact same miRNA degradation kinetics, all target mRNA is expected to be degraded in 3T3 cells across a broad range of conditions, while in oocytes we don't see noticeable degradation in most conditions. 

TODO: the plots are not very colorblind-friendly, make also contour plots.
