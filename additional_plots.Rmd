---
title: "Plots for the main paper"
output: pdf_document
---

2D and 2E same vertical axis (1.6) step 0.2
3A and 3B same vertical axis (1.4)

lighter color bar to mean

mean the same color
larger points

```{r setup, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(dplyr)
library(tidyr)
library(tibble)
library(cowplot) #Optional, can be commented out
library(knitr)
library(here)
library(readxl)

temp_dir <- "local_temp_data"
if(!dir.exists(temp_dir)) {
  dir.create(temp_dir)
}
```

```{r}
animals_levels_raw <- c("mouse","cow","pig")
animals_labels <- c("Mouse","Bovine","Porcine")
```


```{r}
luciferase_file <- here("private_data", "190603 for martin.xlsx")
luciferase_data <-  read_excel(luciferase_file, sheet = "Nanoluc-20 hours-mammals", range = "A2:B100", col_names = c("Condition", "Activity"))

luciferase_data <- luciferase_data %>%
  filter(Condition != "") %>%
  separate(Condition, into = c("Animal_raw", "Binding"), sep = " ") %>%
  mutate(Animal = factor(Animal_raw, levels = animals_levels_raw, labels = animals_labels))
```

```{r}
base_plot <- function(data, x, y, y_expand = c()) {
  # The large_point version
  mean_in_color = TRUE
  line_size = 1
  point_size = 2.25

  # THe small_points version
  # mean_in_color = FALSE
  # line_size = 1
  # point_size = 1.5
  
  x <- enquo(x)
  y <- enquo(y)
  
  if(mean_in_color) {
    mean_summary <- stat_summary(geom = "errorbar", fun.y = "mean", aes(ymax = ..y.., ymin = ..y..), size = line_size)
  } else {
    mean_summary <- stat_summary(geom = "errorbar", fun.y = "mean", aes(ymax = ..y.., ymin = ..y..), color = "black", size = line_size)
  }

  y_breaks <- seq(0, max(pull(data,!!y) + 1.999), by = 0.2)
  
  ggplot(data, aes(x = !!x, y = !!y, color = !!x, fill = !!x, shape = !!x)) +
    stat_summary(geom = "bar", fun.data = "mean_se", width = 0.9, alpha = 0.15, color = NA) +
    stat_summary(geom = "errorbar", fun.data = "mean_se", width = 0.5, size = line_size) +
    mean_summary +
    geom_point(position = position_jitter(width = 0.35, height = 0), size = point_size) +
    scale_color_manual(values = c("#0000CD", "#ff0000", "#505050")) +
    scale_fill_manual(values = c("#0000CD", "#ff0000", "#505050")) +
    theme(axis.text.x = element_blank(), axis.title.x = element_blank(), axis.ticks.x = element_blank()) +
    guides(color = guide_legend(override.aes = list(alpha = 1, linetype = 0, fill = NA))) + 
    expand_limits(y = c(0, y_expand)) + scale_y_continuous(expand = expand_scale(mult = c(0, .05)), breaks = y_breaks)
}

plots <- list()
widths <- list()
```


Fig 2D
```{r, fig.height=3, fig.width=6}
plots$luciferase <- luciferase_data %>%
  base_plot(Binding, Activity, y_expand = c(0, 1.6)) +
  facet_wrap(~Animal)


plots$luciferase
```

Fig S2 C

```{r, fig.height=3, fig.width=6}
combined_file <- here("private_data", "200115 for martin.xlsx")
miR30c_data <- read_excel(combined_file, sheet = "miR-30c mammals") %>% 
  mutate(Animal = factor(Animal, levels = animals_labels))
plots$miR30c <- base_plot(miR30c_data, Reporter, `Relative nanoluc activity`) + facet_wrap(~Animal)
plots$miR30c
```

Fig 2E

```{r, fig.height = 3, fig.width = 3.5}
let7a_porcine_data <- read_excel(combined_file, sheet = "Let-7a porcine 40hours", col_names = c("Animal","Reporter","Activity"), range = "A1:C10")
plots$let7a_porcine <- base_plot(let7a_porcine_data, Reporter, Activity, y_expand = 1.6) + facet_wrap(~Animal)
widths$let7a_porcine <- 3.5
plots$let7a_porcine
```

Fig S2B

```{r, fig.height=3, fig.width=5}
let7_miR_3t3_data <- read_excel(combined_file, sheet = "Let-7a and miR-30c 3t3")
plots$let7_miR_3t3 <- base_plot(let7_miR_3t3_data, Reporter, `Relative nanoluc activity`) +
  facet_wrap(~miRNA)
widths$let7_miR_3t3 <- 5

plots$let7_miR_3t3
```

Fig. 3B

```{r, fig.height=3, fig.width=6}
number_mimic_levels <- c("500k","250k", "100k")
porcine_mimics_data <- read_excel(combined_file, sheet = "porcine mimics") %>%
  mutate(number_mimic = factor(`number of mimic molecules`, levels = number_mimic_levels))
plots$porcine_mimics <- base_plot(porcine_mimics_data, Reporter, `Relative nanoluc activity`, y_expand = 1.4) +
  facet_wrap(~number_mimic)

plots$porcine_mimics
```

Fig 3A

```{r, fig.height=3, fig.width=6}
number_mimic_levels <- c("500k","250k", "100k")
mouse_mimics_data <- read_excel(combined_file, sheet = "mouse mimics") %>%
  mutate(number_mimic = factor(`number of mimic molecules`, levels = number_mimic_levels))
plots$mouse_mimics <- base_plot(mouse_mimics_data, Reporter, `Relative nanoluc activity`, y_expand = 1.4) +
  facet_wrap(~number_mimic)

plots$mouse_mimics
```

```{r}
three_groups_width = 6
base_height = 3
for(type in c(".png",".wmf")) {
  for(plot_name in names(plots)) {
    if(!is.null(widths[[plot_name]])) {
      width = widths[[plot_name]]
    } else {
      width = three_groups_width
    }
    ggsave(paste0(temp_dir,"/", plot_name, type), plots[[plot_name]], width = width, height = base_height)
  }
}

```

